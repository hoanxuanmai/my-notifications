// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum NotificationType {
  info
  success
  warning
  error
  debug
}

enum NotificationPriority {
  low
  medium
  high
  urgent
}

enum DeliveryChannelType {
  WEB_SOCKET
  WEB_PUSH
}

model User {
  id        String    @id @default(uuid())
  email     String    @unique @db.VarChar(255)
  username  String    @unique @db.VarChar(255)
  password  String    @db.VarChar(255)
  name      String?   @db.VarChar(255)
  avatar    String?   @db.VarChar(500)
  isActive  Boolean   @default(true) @map("is_active")
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  
  channels           Channel[]
  channelMemberships ChannelMember[]
  deliveryChannels   UserDeliveryChannel[]

  @@index([email], name: "idx_users_email")
  @@index([username], name: "idx_users_username")
  @@map("users")
}

model Channel {
  id           String    @id @default(uuid())
  name         String    @db.VarChar(255)
  description  String?   @db.Text
  webhookToken String    @unique @map("webhook_token") @db.VarChar(255)
  apiKey       String?   @map("api_key") @db.VarChar(255)
  settings     Json      @default("{}")
  isActive     Boolean   @default(true) @map("is_active")
  userId       String    @map("user_id")
  createdAt    DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt    DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  expiresAt    DateTime  @map("expires_at") @db.Timestamptz(6)
  
  user         User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  notifications Notification[]
  members      ChannelMember[]

  @@index([webhookToken], name: "idx_channels_webhook_token")
  @@index([expiresAt], name: "idx_channels_expires_at")
  @@index([isActive], name: "idx_channels_is_active")
  @@index([userId], name: "idx_channels_user_id")
  @@index([createdAt(sort: Desc)], name: "idx_channels_created_at")
  @@map("channels")
}

model ChannelMember {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  channelId String   @map("channel_id")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  channel Channel @relation(fields: [channelId], references: [id], onDelete: Cascade)

  @@unique([userId, channelId], name: "uniq_channel_member")
  @@index([channelId], name: "idx_channel_members_channel_id")
  @@index([userId], name: "idx_channel_members_user_id")
  @@map("channel_members")
}

model Notification {
  id         String              @id @default(uuid())
  channelId  String              @map("channel_id")
  title      String              @db.VarChar(500)
  message    String              @db.Text
  type       NotificationType    @default(info)
  priority   NotificationPriority @default(medium)
  read       Boolean             @default(false)
  metadata   Json                @default("{}")
  readAt     DateTime?           @map("read_at") @db.Timestamptz(6)
  createdAt  DateTime            @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt  DateTime            @updatedAt @map("updated_at") @db.Timestamptz(6)
  expiresAt  DateTime            @map("expires_at") @db.Timestamptz(6)
  
  channel    Channel             @relation(fields: [channelId], references: [id], onDelete: Cascade)

  @@index([channelId], name: "idx_notifications_channel_id")
  @@index([createdAt(sort: Desc)], name: "idx_notifications_created_at")
  @@index([expiresAt], name: "idx_notifications_expires_at")
  @@index([type], name: "idx_notifications_type")
  @@index([priority], name: "idx_notifications_priority")
  @@index([channelId, createdAt(sort: Desc)], name: "idx_notifications_channel_created")
  @@map("notifications")
}

model UserDeliveryChannel {
  id        String              @id @default(uuid())
  userId    String              @map("user_id")
  type      DeliveryChannelType @map("type")
  config    Json                @default("{}")
  isActive  Boolean             @default(true) @map("is_active")
  createdAt DateTime            @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime            @updatedAt @map("updated_at") @db.Timestamptz(6)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId], name: "idx_user_delivery_channels_user_id")
  @@map("user_delivery_channels")
}

